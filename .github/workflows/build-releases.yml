name: Build and Release EdoCraft

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Make .love file
        run: |
          Compress-Archive -Path program -DestinationPath EdoCraft2025.zip
          Rename-Item EdoCraft2025.zip EdoCraft2025.love

      - name: Download LOVE2D for Windows
        run: |
          curl -L https://github.com/love2d/love/releases/download/11.5/love-11.5-win64.zip -o love-win64.zip
          Expand-Archive love-win64.zip love

      - name: Build Windows standalone
        run: |
          # 1. Create the fused executable
          cmd /c "copy /b love\love-11.5-win64\love.exe+EdoCraft2025.love EdoCraft2025.exe"
          
          # 2. Copy standard LOVE DLLs (SDL2.dll, OpenAL32.dll, love.dll)
          copy love\love-11.5-win64\*.dll .
          
          # 3. FIX: Copy nuklear.dll from your source folder to the root
          # (Ensure nuklear.dll is actually inside your 'program' folder in the repo)
          copy program\nuklear.dll .

      - name: Package ZIP for release
        run: |
          # The *.dll wildcard will now pick up nuklear.dll + the standard LOVE dlls
          Compress-Archive -Path EdoCraft2025.exe,*.dll -DestinationPath EdoCraft2025_Windows.zip

      - name: Create Release and Upload
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ github.run_number }}
          name: Release v${{ github.run_number }}
          files: EdoCraft2025_Windows.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}